generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id       String   @id @default(uuid())
  email    String   @unique
  password String
  type     String   // COORDINATOR | MANAGER
  name     String?

  roles                 Role[]
  collaborators         Collaborator[]
  squads                Squad[]
  integrationEvents     IntegrationEvent[]
  feedbacks             Feedback[]

  managerRequestsSent     ManagerCoordinatorLink[] @relation("ManagerRequests")
  coordinatorRequestsRcvd ManagerCoordinatorLink[] @relation("CoordinatorRequests")
}

model ManagerCoordinatorLink {
  id            String     @id @default(uuid())
  managerId     String
  coordinatorId String
  status        String     @default("PENDING") // PENDING | APPROVED | REJECTED
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  manager      User @relation("ManagerRequests", fields: [managerId], references: [id])
  coordinator  User @relation("CoordinatorRequests", fields: [coordinatorId], references: [id])

  @@unique([managerId, coordinatorId])
}

model Role {
  id             String  @id @default(uuid())
  name           String
  defaultColor   String  @default("#cccccc")
  qtyPerSquad    Int
  maxSquads      Int     @default(1)
  multipleSquads Boolean @default(false)
  order          Int     @default(0)

  coordinatorId  String
  coordinator    User @relation(fields: [coordinatorId], references: [id])

  collaborators  Collaborator[]
}

model Collaborator {
  id              String       @id @default(uuid())
  name            String
  email           String?
  address         String?
  deliveryAddress String?
  photoUrl        String?
  admissionDate   DateTime
  birthDate       DateTime?
  resignationDate DateTime?
  hasChildren     Boolean      @default(false)
  whatsapp        String?
  
  contractType    String       @default("CLT") // CLT | THIRD_PARTY
  seniority       String       @default("JUNIOR") // JUNIOR | PLENO | SENIOR | SPECIALIST
  devType         String       @default("NOT_APPLICABLE") // NOT_APPLICABLE | BACKEND | FRONTEND | FULLSTACK | TECH_LEAD

  roleId          String
  role            Role         @relation(fields: [roleId], references: [id])

  coordinatorId   String
  coordinator     User         @relation(fields: [coordinatorId], references: [id])

  squads          SquadCollaborator[]
  timeBankEntries TimeBankEntry[]
  events          IntegrationEventCollaborator[]
  feedbacks       Feedback[]
}

model Squad {
  id             String    @id @default(uuid())
  name           String
  jiraLink       String?
  confluenceLink String?
  sprintStart    DateTime?
  sprintDays     Int?      @default(14)

  coordinatorId  String
  coordinator    User      @relation(fields: [coordinatorId], references: [id])

  collaborators  SquadCollaborator[]
}

model SquadCollaborator {
  id             String @id @default(uuid())
  squadId        String
  collaboratorId String

  squad          Squad        @relation(fields: [squadId], references: [id])
  collaborator   Collaborator @relation(fields: [collaboratorId], references: [id])

  @@unique([squadId, collaboratorId])
}

model IntegrationEvent {
  id            String   @id @default(uuid())
  startDate     DateTime
  endDate       DateTime
  
  coordinatorId String
  coordinator   User     @relation(fields: [coordinatorId], references: [id])

  collaborators IntegrationEventCollaborator[]
}

model IntegrationEventCollaborator {
  id              String @id @default(uuid())
  eventId         String
  collaboratorId  String

  event           IntegrationEvent @relation(fields: [eventId], references: [id])
  collaborator    Collaborator     @relation(fields: [collaboratorId], references: [id])

  @@unique([eventId, collaboratorId])
}

model TimeBankEntry {
  id             String   @id @default(uuid())
  date           DateTime
  expirationDate DateTime
  balanceHours   Float

  collaboratorId String
  collaborator   Collaborator @relation(fields: [collaboratorId], references: [id])

  @@index([collaboratorId])
  @@index([expirationDate])
}

model Feedback {
  id             String         @id @default(uuid())
  date           DateTime
  content        String
  tag            String?
  type           String         @default("NEUTRAL") // POSITIVE | NEGATIVE | NEUTRAL
  origin         String         @default("PERIODIC") // COLLABORATOR_REQUEST | PERIODIC | PEER_REQUEST | CONFLICT
  
  collaboratorId String
  collaborator   Collaborator   @relation(fields: [collaboratorId], references: [id])
  
  coordinatorId  String
  coordinator    User           @relation(fields: [coordinatorId], references: [id])

  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  @@index([collaboratorId])
  @@index([coordinatorId])
}
